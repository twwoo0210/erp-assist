name: Supabase Setup (Secrets + Functions)

on:
  push:
    branches: ['main']
  workflow_dispatch:
permissions:
  contents: read

env:
  SUPABASE_PROJECT_REF: dopojluhmixbfghsgwfn

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1

      - name: Link project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN || vars.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "::error::Missing SUPABASE_ACCESS_TOKEN (add as Actions secret/variable)"
            echo "::error::Please set SUPABASE_ACCESS_TOKEN in GitHub Secrets (Settings > Secrets and variables > Actions)"
            echo "::error::Token format should be: sbp_0102...1920"
            exit 1
          fi
          if [[ ! "$SUPABASE_ACCESS_TOKEN" =~ ^sbp_ ]]; then
            echo "::error::Invalid SUPABASE_ACCESS_TOKEN format"
            echo "::error::Token must start with 'sbp_' (e.g., sbp_0102...1920)"
            exit 1
          fi
          supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Set Supabase secrets (Ecount + Required)
        env:
          ECOUNT_COMPANY_CODE: ${{ secrets.ECOUNT_COMPANY_CODE || vars.ECOUNT_COMPANY_CODE }}
          ECOUNT_USER_ID: ${{ secrets.ECOUNT_USER_ID || vars.ECOUNT_USER_ID }}
          ECOUNT_API_KEY: ${{ secrets.ECOUNT_API_KEY || vars.ECOUNT_API_KEY }}
          SUPABASE_URL: ${{ vars.VITE_PUBLIC_SUPABASE_URL || secrets.VITE_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || vars.SUPABASE_SERVICE_ROLE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY || vars.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL || vars.GEMINI_MODEL }}
        run: |
          missing=false
          for k in ECOUNT_COMPANY_CODE ECOUNT_USER_ID ECOUNT_API_KEY SUPABASE_URL SUPABASE_SERVICE_ROLE_KEY; do
            v=$(eval echo "\$$k")
            if [ -z "$v" ]; then echo "::error::$k is missing"; missing=true; fi
          done
          if [ "$missing" = true ]; then exit 1; fi

          supabase secrets set \
            ECOUNT_COMPANY_CODE="$ECOUNT_COMPANY_CODE" \
            ECOUNT_USER_ID="$ECOUNT_USER_ID" \
            ECOUNT_API_KEY="$ECOUNT_API_KEY" \
            SUPABASE_URL="$SUPABASE_URL" \
            SUPABASE_SERVICE_ROLE_KEY="$SUPABASE_SERVICE_ROLE_KEY"

          # Optional AI keys
          if [ -n "$GEMINI_API_KEY" ]; then
            supabase secrets set GEMINI_API_KEY="$GEMINI_API_KEY"
          fi
          if [ -n "$GEMINI_MODEL" ]; then
            supabase secrets set GEMINI_MODEL="$GEMINI_MODEL"
          fi

      - name: Apply DB schema (migrations)
        run: |
          supabase db push

      - name: Deploy Supabase Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN || vars.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -e
          if [ ! -d supabase/functions ]; then
            echo 'No supabase/functions directory found; skipping deploy'
            exit 0
          fi
          for d in supabase/functions/*; do
            if [ -d "$d" ]; then
              fn=$(basename "$d")
              echo "Deploying $fn ..."
              supabase functions deploy "$fn"
            fi
          done


